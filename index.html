async function submitBooking() {
  const fname = document.getElementById("fname").value.trim();
  const lname = document.getElementById("lname").value.trim();
  const email = document.getElementById("email").value.trim();
  const reason = document.getElementById("reason").value.trim();

  if (!fname || !lname || !email || !reason) {
    alert("Please fill in all fields.");
    return;
  }

  // ✅ Preload all existing bookings for this user on this date
  const userBookingsSnapshot = await db.collection("bookings")
    .where("date", "==", selectedDate)
    .where("email", "==", email)
    .get();

  const userBookings = userBookingsSnapshot.docs.map(doc => ({
    room: doc.data().room,
    time: doc.data().time
  }));

  for (const id of selectedSlots) {
    const [rIdx, tIdx] = id.split("-").map(Number);
    const room = rooms[rIdx];
    const time = times[tIdx];

    const alreadyBooked = userBookings.some(b => b.room === room && b.time === time);
    if (alreadyBooked) {
      alert(`You already booked ${room} at ${time}`);
      continue;
    }

    await db.collection("bookings").add({
      date: selectedDate,
      room,
      time,
      name: `${fname} ${lname}`,
      email,
      reason
    });

    await logEvent("Booked", room, time, email);
  }

  // ✅ Clear form + selection
  document.getElementById("reason").value = "";
  selectedSlots.length = 0;
  document.querySelectorAll(".selected").forEach(el => el.classList.remove("selected"));

  // ✅ Refill name/email fields if logged in
  if (currentUser) {
    const displayName = currentUser.displayName || "";
    const [firstName, ...rest] = displayName.split(" ");
    document.getElementById("fname").value = firstName || "";
    document.getElementById("lname").value = rest.join(" ") || "";
    document.getElementById("email").value = currentUser.email || "";
  }

  // ✅ Refresh UI now that bookings are done
  document.getElementById("booking-form").style.display = "none";
  await loadBookings(); // ← this makes the slots turn orange immediately
}
