<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <title>Room Booking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }

    .header {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #244564;
      color: white;
      padding: 20px 20px;
      border-radius: 8px;
      margin-bottom: 20px;

      /* Add shadow and box styling */
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      margin: 0;
      font-size: 29px;
    }

    #clock {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;

    }

    #sign-out {
      background-color: #ff4d4f;
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      display: inline-block;
    }

    #sign-out:hover {
      background-color: #d9363e;
    }

    .date-controls {
      background-color: #e6f0ff;
      border: 1px solid #244564;
      border-radius: 10px;
      padding: 20px 24px;
      max-width: 600px;
      margin: 20px auto;
      box-shadow: 0 4px 12px rgba(36, 69, 100, 0.25);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      font-family: 'Segoe UI', sans-serif;
      color: #244564;
      font-weight: 600;
    }

    .date-controls button {
      padding: 8px 12px;
      background-color: #244564;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .date-controls button:hover {
      background-color: #003060;
    }

    #custom-date-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #date-picker {
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .grid {
      display: grid;
      grid-template-columns: 150px repeat(22, 1fr);
      grid-auto-rows: 50px;
      gap: 2px;
      max-width: 95vw;
      overflow-x: auto;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 3px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      margin: 0 auto;
      display: grid;
      justify-content: center;
    }

    #sign-in-google {
      padding: 8px 12px;
      background-color: #244564;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #sign-in-google:hover {
      background-color: #003060;
    }

    #sign-in-microsoft {
      padding: 8px 12px;
      background-color: #244564;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #sign-in-microsoft:hover {
      background-color: #003060;
    }

    .room-label,
    .time-label,
    .slot {
      border: none;
      text-align: center;
      padding: 5px 5px;
      box-sizing: border-box;
      font-size: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .slot {
      aspect-ratio: 1 / 1;
      width: 100%;
      height: 100%;

    }

    .room-label {
      color: #244564;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      text-align: center;
      font-weight: bold;
    }

    .time-label {
      color: #818486;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      text-align: center;
    }

    .available {
      background: #9fe6ae;
      cursor: pointer;
      border-radius: 6px;

    }

    .available:hover {
      background: #7ab887;
    }

    .selected {
      background: #fff176;
      border-radius: 6px;
    }

    .selected:hover {
      background: #d8cc5c;
    }

    .booked {
      background: #333;
      color: #fff;
      cursor: pointer;
      border-radius: 6px;
    }

    .past {
      background: #ddd;
      color: #999;
      cursor: not-allowed;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border-radius: 6px;
    }

    .legend {
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      line-height: 1.8;
      color: #244564;
    }

    .legend div {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin: 0 5px;
      border-radius: 50%;
      vertical-align: middle;
    }

    #booking-form,
    #unbooking-form {
      display: none;
      background-color: #ffffff;
      max-width: 350px;
      margin: 30px auto;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      font-family: 'Segoe UI', sans-serif;
      text-align: left;
    }

    #booking-form h3 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 20px;
      text-align: center;
      color: #003366;
    }

    #booking-form input,
    #unbooking-form input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    #unbooking-form {
      display: none;
      background-color: #ffffff;
      max-width: 350px;
      margin: 30px auto;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      font-family: 'Segoe UI', sans-serif;
      text-align: left;
    }

    #unbooking-form h3 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 20px;
      text-align: center;
      color: #003366;
    }

    #unbooking-form div#unbooking-info {
      font-size: 14px;
      color: #244564;
      margin-bottom: 20px;
      white-space: pre-line;
      /* to preserve line breaks */
    }

    #unbooking-form button {
      width: 48%;
      padding: 12px;
      font-weight: bold;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s ease;
    }

    #unbooking-form button:first-of-type {
      background-color: #ff4d4f;
      /* red for Unbook */
      color: white;
      margin-right: 4%;
    }

    #unbooking-form button:first-of-type:hover {
      background-color: #d9363e;
    }

    #unbooking-form button:last-of-type {
      background-color: #cccccc;
      /* grey for Cancel */
      color: #333;
    }

    #unbooking-form button:last-of-type:hover {
      background-color: #999999;
    }

    #booking-form input:focus {
      border-color: #007bff;
      outline: none;
    }

    #booking-form button {
      width: 100%;
      padding: 12px;
      background-color: #004080;
      color: white;
      font-weight: bold;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #booking-form button:hover {
      background-color: #002f66;
    }

    #admin-log ul {
      padding: 0;
      list-style-type: none;
    }

    #admin-log li {
      background-color: #f0f4f8;
      padding: 10px 14px;
      margin-bottom: 6px;
      border-radius: 8px;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
      color: #333;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      line-height: 1.4;
    }

    #user-list-items li {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    #room-tooltip {
      position: absolute;
      display: none;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      max-width: 250px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      z-index: 1000;
      pointer-events: none;
      /* so it doesn't block mouse */
    }

    #room-tooltip img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    /* Container for cleanup, activity log, and user list */
    #cleanup-controls,
    #admin-panel {
      background-color: #e6f0ff;
      border: 1px solid #244564;
      border-radius: 10px;
      padding: 20px;
      margin-top: 30px;
      box-shadow: 0 4px 12px rgba(36, 69, 100, 0.25);
      color: #244564;
      font-family: 'Segoe UI', sans-serif;
    }

    #cleanup-controls {
      display: none;
      margin-top: 30px;
      border: 1px solid #244564;
      border-radius: 8px;
      padding: 20px;
      background: #e6f0ff;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Cleanup section */
    #cleanup-controls h4 {
      color: #003060;
      margin-bottom: 12px;
      font-weight: 700;
      font-size: 18px;
    }

    #cleanup-controls label {
      font-weight: 600;
      margin-right: 10px;
      color: #244564;
    }

    #cleanup-select,
    #cleanup-btn {
      font-weight: 600;
    }

    #cleanup-btn {
      background-color: #244564;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-left: 10px;
    }

    #cleanup-btn:hover {
      background-color: #003060;
    }

    /* Activity Log and User List Panels */
    #admin-panel {
      display: flex;
      gap: 30px;
      max-width: 900px;
      margin: 30px auto;
      text-align: left;
      flex-wrap: wrap;
    }

    #admin-log,
    #user-list {
      background-color: #f0f7ff;
      /* lighter blue */
      border: 1px solid #aaccee;
      border-radius: 10px;
      padding: 20px;
      flex: 1 1 400px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: inset 0 0 10px rgba(36, 69, 100, 0.1);
      color: #244564;
    }

    #admin-log h3,
    #user-list h3 {
      color: #003060;
      font-weight: 700;
      margin-bottom: 15px;
      font-size: 20px;
      border-bottom: 2px solid #244564;
      padding-bottom: 6px;
    }

    #log-list li,
    #user-list-items li {
      background-color: white;
      margin-bottom: 8px;
      padding: 12px 16px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(36, 69, 100, 0.15);
      font-size: 14px;
      color: #003060;
      word-break: break-word;
    }

    #log-list li:hover,
    #user-list-items li:hover {
      background-color: #d9e6ff;
      cursor: default;
    }

    /* Scrollbar styling (optional) */
    #admin-log::-webkit-scrollbar,
    #user-list::-webkit-scrollbar {
      width: 8px;
    }

    #admin-log::-webkit-scrollbar-thumb,
    #user-list::-webkit-scrollbar-thumb {
      background-color: #244564;
      border-radius: 4px;
    }

    #cleanup-status {
      font-weight: 600;
      margin-top: 10px;
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>Room Booking</h1>
    <div id="clock"><i class="fa-solid fa-clock"></i> --:--</div>
    <button id="sign-out" style="display: none;">Sign Out</button>
  </div>
  <div id="auth-section" style="margin-bottom: 20px;">
    <button id="sign-in-google">Sign in with Google</button>
    <button id="sign-in-microsoft">Sign in with Microsoft</button>
    <span id="user-email" style="margin-left: 15px; font-weight: bold;"></span>
  </div>

  <div id="date-controls" class="date-controls">
    <button onclick="changeDate(-1)"><strong>&lt</strong> Previous</button>
    <div id="custom-date-wrapper">
      <input type="date" id="date-picker" />
    </div>
    <button onclick="changeDate(1)">Next <strong>&gt</strong></button>
    <button onclick="goToToday()">Today</button>
  </div>


  <div id="app-container" style="display: none;">

    <div class="grid" id="grid"></div>

    <div id="booking-form">
      <h3>Confirm Booking</h3>
      <input type="text" id="fname" placeholder="First Name" readonly />
      <input type="text" id="lname" placeholder="Last Name" readonly />
      <input type="email" id="email" placeholder="Email" readonly />
      <input type="text" id="reason" placeholder="Reason" />
      <input type="text" id="meeting-needs" placeholder="Meeting Needs" />
      <button onclick="submitBooking()">Submit</button>
    </div>

    <div id="unbooking-form">
      <h3>Confirm Unbooking</h3>
      <div id="unbooking-info"></div>
      <button onclick="submitUnbooking()">Unbook</button>
      <button onclick="cancelUnbooking()">Cancel</button>
    </div>

    <div class="legend">
      <div style="background:#a8e6a1;"></div> Available
      <div style="background:#fff176;"></div> Selected
      <div style="background:orange;"></div> My Booking
      <div style="background:#333;"></div> Booked
      <div style="background:#ddd;"></div> Past
    </div>
  </div>
  <div id="cleanup-controls" style="display:none; margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px;">
    <h4>Cleanup Old Data</h4>
    <label for="retention-select">Delete data older than:</label>
    <select id="retention-select">
      <option value="30">30 days</option>
      <option value="60">60 days</option>
      <option value="90">90 days</option>
    </select>
    <button id="cleanup-btn">Delete Old Bookings & Logs</button>
    <div id="cleanup-status" style="margin-top:10px; color: green;"></div>
  </div>

  <div id="admin-toggle" style="display: none; text-align: center; margin-top: 20px;">
    <button id="toggle-admin-btn"
      style="padding: 10px 16px; background-color: #244564; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
      Show Admin Panel
    </button>
  </div>

  <div id="admin-panel" style="display: none; gap: 30px; max-width: 900px; margin: 30px auto; text-align: left;">

    <div id="admin-log" style="flex: 2;">
      <h3>Activity Log</h3>
      <ul id="log-list" style="list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto;"></ul>
    </div>

    <div id="user-list" style="flex: 2;">
      <h3>User List</h3>
      <ul id="user-list-items" style="list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto;"></ul>
    </div>

  </div>
  <div id="room-tooltip"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    let isMouseDown = false;
    let isSelecting = true; // true = selecting, false = unselecting
    let dragStartRow = null;

    const firebaseConfig = {
      apiKey: "AIzaSyAv2l6sulhI9Rq2P-TB1DXpUlrWIB2BUqE",
      authDomain: "roombookinggrid.firebaseapp.com",
      projectId: "roombookinggrid",
      storageBucket: "roombookinggrid.firebasestorage.app",
      messagingSenderId: "552235186164",
      appId: "1:552235186164:web:ebb72b6bb33cbe35716ba1",
      measurementId: "G-M2MV4ZEKZJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function checkIfAdmin(email) {
      try {
        const doc = await db.collection("roles").doc(email).get();
        return doc.exists && doc.data().role === "admin";
      } catch (error) {
        console.error("Error checking admin role:", error);
        return false;
      }
    }

    let currentUser = null;

    firebase.auth().onAuthStateChanged(async user => {
      if (user) {
        const domain = user.email.split("@")[1];
        const allowedDomains = ["k12insight.com", "sogolytics.com", "zarca.com"];
        document.getElementById("app-container").style.display = "block";
        document.getElementById("date-controls").style.display = "flex";
        if (!allowedDomains.includes(domain)) {
          alert("Access denied: unauthorized domain.");
          firebase.auth().signOut();
          return;
        }

        currentUser = user;
        const userDoc = db.collection("users").doc(user.uid);
        const doc = await userDoc.get();
        if (!doc.exists) {
          await userDoc.set({
            email: user.email,
            name: user.displayName || "",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Move this admin check and UI toggle outside the if-block
        const isAdmin = await checkIfAdmin(user.email);
        if (isAdmin) {
          document.getElementById("admin-log").style.display = "block";
          document.getElementById("cleanup-controls").style.display = "block";
          document.getElementById("admin-panel").style.display = "none";
          document.getElementById("admin-toggle").style.display = "block";
          loadActivityLog();
          loadUserList();
        } else {
          document.getElementById("admin-log").style.display = "none";
          document.getElementById("cleanup-controls").style.display = "none";
          document.getElementById("admin-panel").style.display = "none";
        }

        // Update UI (name fields, email display, etc)
        if (user.displayName) {
          const [firstName, ...rest] = user.displayName.split(" ");
          const lastName = rest.join(" ");
          document.getElementById("fname").value = firstName || "";
          document.getElementById("lname").value = lastName || "";
        }
        let fullName = user.displayName || "";
        if (!fullName) {
          fullName = `${document.getElementById("fname").value} ${document.getElementById("lname").value}`;
        }
        document.getElementById("user-email").textContent = `${fullName} – ${user.email}${isAdmin ? " (Admin)" : ""}`;
        document.getElementById("sign-in-google").style.display = "none";
        document.getElementById("sign-in-microsoft").style.display = "none";
        document.getElementById("sign-out").style.display = "inline-block";

        // Auto-fill form fields
        document.getElementById("email").value = user.email;
        if (user.displayName) {
          const [firstName, ...rest] = user.displayName.split(" ");
          const lastName = rest.join(" ");
          document.getElementById("fname").value = firstName || "";
          document.getElementById("lname").value = lastName || "";
        }

        loadBookings();
      } else {
        // Signed out
        document.getElementById("sign-in-google").style.display = "inline-block";
        document.getElementById("sign-in-microsoft").style.display = "inline-block";
        document.getElementById("sign-out").style.display = "none";
        document.getElementById("app-container").style.display = "none";
        document.getElementById("date-controls").style.display = "none";
      }
    });

    function formatDate(dateString) {
      // dateString is like "2025-06-04"
      const parts = dateString.split("-"); // ["2025", "06", "04"]
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1; // zero-based month
      const day = parseInt(parts[2], 10);
      const date = new Date(year, month, day); // local midnight, no UTC shift

      const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
      return date.toLocaleDateString(undefined, options);
    }
    function formatTime12Hour(time24) {
      if (!time24) return "";
      const [hourStr, minute] = time24.split(":");
      let hour = parseInt(hourStr, 10);
      const ampm = hour >= 12 ? "pm" : "am";
      hour = hour % 12;
      if (hour === 0) hour = 12;
      if (minute === "00") {
        return `${hour}${ampm}`;
      } else {
        return `${hour}:${minute}${ampm}`;
      }
    }
    async function loadActivityLog() {
      const logList = document.getElementById("log-list");
      logList.innerHTML = "";
      const snapshot = await db.collection("activityLog")
        .orderBy("timestamp", "desc")
        .get();

      snapshot.forEach(doc => {
        const log = doc.data();
        const actionTime = new Date(log.timestamp).toLocaleString([], {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        let text;
        // If room/time/date are "-" (or you can check the action string), simplify text
        if ((log.room === "-" || !log.room) && (log.time === "-" || !log.time)) {
          text = `[${actionTime}] ${log.email} ${log.action.toLowerCase()}`;
        } else {
          const formattedTime = formatTime12Hour(log.time);
          text = `[${actionTime}] ${log.email} ${log.action.toLowerCase()} "${log.room}" for ${formattedTime} on ${formatDate(log.date)}`;
        }

        const li = document.createElement("li");
        li.textContent = text;
        logList.appendChild(li);
      });
    }
    async function loadUserList() {
      const userListEl = document.getElementById("user-list-items");
      userListEl.innerHTML = "";

      try {
        // Assuming your users are stored in "users" collection (adjust if different)
        const snapshot = await db.collection("users").orderBy("email").get();

        snapshot.forEach(doc => {
          const user = doc.data();
          const li = document.createElement("li");
          li.textContent = `${user.name || "(No Name)"} — ${user.email}`;
          userListEl.appendChild(li);
        });
      } catch (err) {
        userListEl.textContent = "Failed to load users.";
        console.error("Error loading user list:", err);
      }
    }

    const rooms = ["Huddle Room 318", "Huddle Room 317", "Huddle Room 315", "Window Office", "Conference Room"];
    const times = Array.from({ length: 22 }, (_, i) => {
      const hour = 7 + Math.floor(i / 2);
      const min = i % 2 === 0 ? "00" : "30";
      return `${String(hour).padStart(2, "0")}:${min}`;
    });

    const grid = document.getElementById("grid");
    const selectedSlots = [];
    grid.addEventListener("mousedown", (e) => {
      if (!e.target.classList.contains("slot") ||
        e.target.classList.contains("past") ||
        (!e.target.classList.contains("available") && !e.target.classList.contains("selected"))) {
        return;
      }


      e.preventDefault();
      isMouseDown = true;

      const id = e.target.dataset.id;
      dragStartRow = parseInt(id.split("-")[0]);

      const alreadySelected = selectedSlots.includes(id);
      isSelecting = !alreadySelected;

      if (isSelecting && !alreadySelected) {
        selectedSlots.push(id);
        e.target.classList.add("selected");
      } else if (!isSelecting && alreadySelected) {
        selectedSlots.splice(selectedSlots.indexOf(id), 1);
        e.target.classList.remove("selected");
      }

      updateFormVisibility();
    });


    grid.addEventListener("mouseover", (e) => {
      if (!e.target.classList.contains("slot") ||
        e.target.classList.contains("past") ||
        (!e.target.classList.contains("available") && !e.target.classList.contains("selected"))) {
        return;
      }


      const currentRow = parseInt(e.target.dataset.id.split("-")[0]);
      if (currentRow !== dragStartRow) return;  // restrict to same row

      const id = e.target.dataset.id;
      const alreadySelected = selectedSlots.includes(id);

      if (isSelecting && !alreadySelected) {
        selectedSlots.push(id);
        e.target.classList.add("selected");
      } else if (!isSelecting && alreadySelected) {
        selectedSlots.splice(selectedSlots.indexOf(id), 1);
        e.target.classList.remove("selected");
      }

      updateFormVisibility();
    });


    const nowEST = () => new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));

    function updateClock() {
      document.getElementById("clock").innerHTML = `<i class="fa-solid fa-clock"></i> ${nowEST().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })} EST`;

    }
    setInterval(updateClock, 1000);
    updateClock();

    let bookings = [];
    let selectedDate = new Date().toISOString().split("T")[0];
    let unbookingSlot = null;

    document.getElementById("date-picker").value = selectedDate;
    document.getElementById("date-picker").setAttribute("min", selectedDate);
    document.getElementById("date-picker").addEventListener("change", e => {
      selectedDate = e.target.value;
      loadBookings();
    });

    function changeDate(offset) {
      const current = new Date(selectedDate);
      current.setDate(current.getDate() + offset);
      const today = new Date().toISOString().split("T")[0];
      const newDateStr = current.toISOString().split("T")[0];

      if (newDateStr < today) return; // Block past
      selectedDate = newDateStr;
      document.getElementById("date-picker").value = selectedDate;
      loadBookings();
    }

    function goToToday() {
      const today = new Date().toISOString().split("T")[0];
      selectedDate = today;
      document.getElementById("date-picker").value = selectedDate;
      loadBookings();
    }



    async function loadBookings() {
      bookings = [];
      const snapshot = await db.collection("bookings").where("date", "==", selectedDate).get();
      snapshot.forEach(doc => bookings.push({ id: doc.id, ...doc.data() }));
      drawGrid();
      if (currentUser && await checkIfAdmin(currentUser.email)) {
        loadActivityLog();
      }
    }

    function formatTo12Hour(timeStr) {
      const [hour, minute] = timeStr.split(":").map(Number);
      const ampm = hour >= 12 ? "PM" : "AM";
      const hour12 = ((hour + 11) % 12) + 1;
      return `${hour12}:${minute.toString().padStart(2, '0')} ${ampm}`;
    }

    function drawGrid() {
      const tooltip = document.getElementById("room-tooltip");

      grid.innerHTML = "";
      grid.appendChild(document.createElement("div")); // blank top-left corner cell

      // Add time labels at top
      times.forEach(time => {
        const div = document.createElement("div");
        div.className = "time-label";
        div.textContent = formatTo12Hour(time);
        grid.appendChild(div);
      });

      rooms.forEach((room, rIdx) => {
        const roomDiv = document.createElement("div");
        roomDiv.ondblclick = () => {
          selectedSlots.length = 0;
          document.querySelectorAll(".selected").forEach(e => e.classList.remove("selected"));

          times.forEach((time, tIdx) => {
            const id = `${rIdx}-${tIdx}`;
            const slotDiv = grid.querySelector(`.slot[data-id="${id}"]`);
            if (slotDiv && slotDiv.classList.contains("available")) {
              selectedSlots.push(id);
              slotDiv.classList.add("selected");
            }
          });

          updateFormVisibility(); // Only if you already use this
        };

        roomDiv.className = "room-label";
        roomDiv.textContent = room;

        // Tooltip with image + description
        roomDiv.addEventListener("mouseenter", (e) => {
          const info = roomDetails[room];
          if (!info) return;

          tooltip.innerHTML = `
        <img src="${info.photo}" alt="${room} photo" />
        <div>${info.description}</div>
      `;
          tooltip.style.display = "block";

          const rect = e.target.getBoundingClientRect();
          tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
          tooltip.style.left = `${rect.left + window.scrollX}px`;
        });

        roomDiv.addEventListener("mouseleave", () => {
          tooltip.style.display = "none";
        });

        grid.appendChild(roomDiv);

        times.forEach((time, tIdx) => {
          const id = `${rIdx}-${tIdx}`;
          const div = document.createElement("div");
          div.className = "slot";
          div.dataset.id = id;

          if (selectedSlots.includes(id)) {
            div.classList.add("selected");
          }

          const [hour, min] = time.split(":");
          const slotTime = new Date(`${selectedDate}T${hour}:${min}:00`);
          const now = nowEST();

          // Round up to next half-hour
          const roundedNow = new Date(now);
          if (now.getMinutes() < 30) {
            roundedNow.setMinutes(30, 0, 0);
          } else {
            roundedNow.setHours(now.getHours() + 1, 0, 0, 0);
          }

          const isPast = new Date(selectedDate) < new Date(now.toISOString().split("T")[0]) || slotTime < roundedNow;
          const match = bookings.find(b => b.room === room && b.time === time);

          if (isPast) {
            div.classList.add("past");
          } else if (match) {
            const isMine = currentUser && match.email === currentUser.email;
            div.classList.add("booked");

            if (isMine) {
              div.style.background = "orange";
              div.title = `My Booking: ${match.name} (${match.reason})`;
            } else {
              div.title = `${match.name} (${match.reason})`;
              div.style.cursor = "not-allowed";
              div.onclick = null;
            }

            if (isMine || (currentUser && checkIfAdmin)) {
              div.onclick = async () => {
                const isAdmin = await checkIfAdmin(currentUser.email);
                if (isMine || isAdmin) {
                  document.querySelectorAll(".selected").forEach(e => e.classList.remove("selected"));
                  unbookingSlot = match;
                  document.getElementById("unbooking-info").innerText =
                    `Date: ${match.date}
Time: ${match.time}
Name: ${match.name}
Reason: ${match.reason}
Room: ${match.room}`;
                  document.getElementById("unbooking-form").style.display = "block";
                  document.getElementById("booking-form").style.display = "none";
                }
              };
            }
          } else {
            div.classList.add("available");
            div.ondragstart = () => false;
          }

          grid.appendChild(div);
        });
      });
    }

    document.addEventListener("mouseup", () => {
      isMouseDown = false;
      isSelecting = null;
      dragStartRow = null;
    });

    async function logEvent(action, room, time, email) {
      try {
        const timestamp = new Date().toISOString();
        console.log("Logging event:", { action, room, time, email, date: selectedDate });

        await db.collection("activityLog").add({
          timestamp,
          action,
          room,
          time,
          email,
          date: selectedDate
        });

        console.log("✅ Event successfully logged.");
      } catch (err) {
        console.error("❌ Failed to log event:", err);
      }
    }
    async function logAdminAction(actionDescription, email) {
      try {
        const timestamp = new Date().toISOString();
        await db.collection("activityLog").add({
          timestamp,
          action: actionDescription,  // e.g. "Deleted old bookings and logs"
          room: "-",                   // no specific room
          time: "-",                   // no specific time
          email,
          date: timestamp.split("T")[0]  // store current date as string YYYY-MM-DD
        });
        console.log(`✅ Admin action logged: ${actionDescription}`);
      } catch (err) {
        console.error("❌ Failed to log admin action:", err);
      }
    }
    let isAdminPanelOpen = false;

    document.getElementById("toggle-admin-btn").addEventListener("click", async () => {
      const panel = document.getElementById("admin-panel");
      const log = document.getElementById("admin-log");
      const cleanup = document.getElementById("cleanup-controls");
      const btn = document.getElementById("toggle-admin-btn");

      if (!isAdminPanelOpen) {
        panel.style.display = "flex";
        log.style.display = "block";
        cleanup.style.display = "block";
        btn.textContent = "Hide Admin Panel";

        await loadActivityLog();
        await loadUserList();
      } else {
        panel.style.display = "none";
        log.style.display = "none";
        cleanup.style.display = "none";
        btn.textContent = "Show Admin Panel";
      }

      isAdminPanelOpen = !isAdminPanelOpen;
    });

    async function submitBooking() {
      const fname = document.getElementById("fname").value.trim();
      const lname = document.getElementById("lname").value.trim();
      const email = document.getElementById("email").value.trim();
      const reason = document.getElementById("reason").value.trim();
      const needs = document.getElementById("meeting-needs").value.trim();

      if (!fname || !lname || !email) {
        alert("Please fill in your first name, last name, and email.");
        return;
      }

      for (const id of selectedSlots) {
        const [rIdx, tIdx] = id.split("-").map(Number);
        // ✅ Prevent duplicate bookings
        const existing = await db.collection("bookings")
          .where("date", "==", selectedDate)
          .where("room", "==", rooms[rIdx])
          .where("time", "==", times[tIdx])
          .where("email", "==", email)
          .get();

        if (!existing.empty) {
          alert(`You already booked ${rooms[rIdx]} at ${times[tIdx]}`);
          continue; // skip this slot
        }
        await db.collection("bookings").add({
          date: selectedDate,
          room: rooms[rIdx],
          time: times[tIdx],
          name: `${fname} ${lname}`,
          email,
          reason,
          needs
        });
        await logEvent("Booked", rooms[rIdx], times[tIdx], email);
      }

      document.getElementById("reason").value = "";

      // Reset name and email fields to current user's info
      if (currentUser) {
        const displayName = currentUser.displayName || "";
        const [firstName, ...rest] = displayName.split(" ");
        const lastName = rest.join(" ");

        document.getElementById("fname").value = firstName || "";
        document.getElementById("lname").value = lastName || "";
        document.getElementById("email").value = currentUser.email || "";
      }
      selectedSlots.length = 0;
      document.getElementById("booking-form").style.display = "none";
      document.querySelectorAll(".selected").forEach(el => el.classList.remove("selected"));
      await loadBookings();
    }

    async function submitUnbooking() {
      if (!currentUser || !unbookingSlot) {
        alert("You must be signed in to unbook.");
        return;
      }

      const isOwner = currentUser.email === unbookingSlot.email;

      const isAdmin = await checkIfAdmin(currentUser.email); // force check here
      if (isAdmin || isOwner) {
        await db.collection("bookings").doc(unbookingSlot.id).delete();
        await logEvent("Unbooked", unbookingSlot.room, unbookingSlot.time, currentUser.email);
        unbookingSlot = null;
        document.getElementById("unbooking-form").style.display = "none";
        selectedSlots.length = 0;
        document.querySelectorAll(".selected").forEach(el => el.classList.remove("selected"));
        await loadBookings();
      } else {
        alert("You can only unbook your own reservations.");
      }
    }

    function cancelUnbooking() {
      document.getElementById("unbooking-form").style.display = "none";
      unbookingSlot = null;
    }
    function updateFormVisibility() {
      const bookingForm = document.getElementById("booking-form");
      const unbookingForm = document.getElementById("unbooking-form");

      if (selectedSlots.length > 0) {
        bookingForm.style.display = "block";
        unbookingForm.style.display = "none";
      } else {
        bookingForm.style.display = "none";
      }
    }


    let justFinishedDrag = false;

    grid.addEventListener("mouseup", () => {
      // Drag finished
      justFinishedDrag = true;
      setTimeout(() => {
        justFinishedDrag = false;
      }, 100); // reset after 100ms
    });

    document.addEventListener("mouseup", function (e) {
      if (justFinishedDrag) {
        // Don't clear selection immediately after drag ended
        return;
      }

      const bookingForm = document.getElementById("booking-form");
      const clickedSlot = e.target.classList.contains("available") || e.target.classList.contains("selected");
      const clickedInsideForm = bookingForm.contains(e.target);

      if (bookingForm.style.display === "block" &&
        !clickedSlot &&
        !clickedInsideForm) {
        selectedSlots.length = 0;
        document.querySelectorAll(".selected").forEach(el => el.classList.remove("selected"));
        bookingForm.style.display = "none";
      }
    });
    const wrapper = document.getElementById("custom-date-wrapper");
    const picker = document.getElementById("date-picker");

    if (picker.showPicker) {
      wrapper.addEventListener("click", () => {
        picker.showPicker(); // Opens calendar popup
      });
    }

    document.getElementById("sign-in-google").addEventListener("click", async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      try {
        await firebase.auth().signInWithPopup(provider);
      } catch (error) {
        alert("Google sign-in failed: " + error.message);
      }
    });

    document.getElementById("sign-in-microsoft").addEventListener("click", async () => {
      const provider = new firebase.auth.OAuthProvider('microsoft.com');
      provider.setCustomParameters({ prompt: 'select_account' });
      try {
        await firebase.auth().signInWithPopup(provider);
      } catch (error) {
        alert("Microsoft sign-in failed: " + error.message);
      }
    });

    document.getElementById("sign-out").addEventListener("click", async () => {
      await firebase.auth().signOut();
      location.reload(); // Optional: clears UI state and refreshes
    });

    document.addEventListener("click", function (e) {
      setTimeout(() => {
        const unbookingForm = document.getElementById("unbooking-form");
        const clickedInsideForm = unbookingForm.contains(e.target);
        const clickedBookedSlot = e.target.classList.contains("booked");

        if (unbookingForm.style.display === "block" && !clickedInsideForm && !clickedBookedSlot) {
          cancelUnbooking();
        }
      }, 0);
    });
    document.getElementById("cleanup-btn").addEventListener("click", async () => {
      const retentionDays = parseInt(document.getElementById("retention-select").value, 10);
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
      const cutoffISOString = cutoffDate.toISOString();

      const statusEl = document.getElementById("cleanup-status");
      statusEl.style.color = "black";
      statusEl.textContent = "Deleting old data... Please wait.";

      try {
        // Delete old bookings
        const oldBookingsSnapshot = await db.collection("bookings")
          .where("date", "<", cutoffISOString.slice(0, 10))  // date stored as 'YYYY-MM-DD'
          .get();

        const bookingDeletes = oldBookingsSnapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(bookingDeletes);

        // Delete old activity logs
        // Assuming timestamp field exists as ISO string or Firestore Timestamp
        const oldLogsSnapshot = await db.collection("activityLog")
          .where("timestamp", "<", cutoffISOString)
          .get();

        const logDeletes = oldLogsSnapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(logDeletes);

        statusEl.style.color = "green";
        statusEl.textContent = `Deleted bookings and logs older than ${retentionDays} days.`;
        // Log the cleanup admin action
        await logAdminAction(`Deleted bookings and logs older than ${retentionDays} days`, currentUser.email);

        // Reload activity log after cleanup
        await loadActivityLog();
        await loadBookings();
      } catch (err) {
        statusEl.style.color = "red";
        statusEl.textContent = `Error deleting old data: ${err.message}`;
        console.error("Cleanup error:", err);
      }
    });
    const roomDetails = {
      "Huddle Room 318": {
        photo: "images/huddleroom318.jpeg",
        description: "Cozy huddle room with seating for 4, whiteboard, and video conferencing."
      },
      "Huddle Room 317": {
        photo: "images/huddleroom317.jpeg",
        description: "Quiet huddle room perfect for small meetings and brainstorming."
      },
      "Huddle Room 315": {
        photo: "images/huddleroom315.jpeg",
        description: "Bright room with natural light and advanced AV equipment."
      },
      "Window Office": {
        photo: "https://example.com/photos/windowoffice.jpg", // external URL stays the same
        description: "Office with large window overlooking the courtyard."
      },
      "Conference Room": {
        photo: "images/conferenceroom.jpeg",
        description: "Large conference room with seating for 12 and projector."
      }
    };
  </script>
</body>

</html>
